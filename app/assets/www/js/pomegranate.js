// Generated by CoffeeScript 1.6.2
(function() {
  $(function() {
    return $(document).on("deviceready", function() {
      var db, error, saveResults, smsByTimeReceived, updateMessageTable;

      db = new PouchDB("Pomegranate");
      smsByTimeReceived = function(doc) {
        if (doc.time_received) {
          return emit(doc.time_received, null);
        }
      };
      saveResults = function(results) {
        return _(results.texts).each(function(text) {
          return db.post(text);
        });
      };
      error = function(error) {
        return console.log("Error: " + (JSON.stringify(error)));
      };
      db.query({
        map: smsByTimeReceived
      }, {
        reduce: false,
        limit: 1,
        include_docs: true,
        descending: true
      }, function(error, response) {
        if (error) {
          console.log("error: " + (JSON.stringify(error)));
        }
        console.log("response: " + (JSON.stringify(response)));
        if (response.rows.length === 0) {
          console.log("No SMS's in DB, loading all SMSs on phone");
          return cordova.exec(saveResults, error, "ReadSms", "GetTexts", ["", -1]);
        } else {
          return cordova.exec(saveResults, error, "ReadSms", "GetTextsAfter", ["", response.rows[0].time_received, -1]);
        }
      });
      $("#send").click(function() {
        var message, number, success;

        number = $("#phone_number").val();
        message = $("#message").val();
        success = function() {
          return alert("Message sent successfully");
        };
        error = function(e) {
          return alert("Message Failed:" + e);
        };
        return cordova.exec(success, error, "SmsPlugin", "SendSMS", [number, message]);
      });
      updateMessageTable = function(results) {
        return $("#messages").html("        <table>          <thead>            <th>from</th>            <th>message</th>            <th>date</th>          </thead>          <tbody>            " + (_(results.texts).map(function(text) {
          return "                  <tr>                    <td>" + text.from + "</td>                    <td>" + text.message + "</td>                    <td>" + text.time_received + "</td>                  </tr>                ";
        }).join("")) + "          </tbody>        </table>      ");
      };
      error = function(error) {
        console.log("THERE WAS AN ERROR!!! aaaaaAAAAHHHHH!!!");
        return console.log(error);
      };
      return cordova.exec(updateMessageTable, error, "ReadSms", "GetTexts", ["", -1]);
    });
  });

}).call(this);
